{% extends "base.html" %}
{% load static %}
{% block title %}AI 대시보드{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-shell">
  <aside class="dashboard-glow" aria-hidden="true"></aside>

  <header class="dashboard-header">
    <div class="dashboard-header__text">
      <!-- ✅ B2 훅: 제목 동적화 (기존 유지) -->
      <h1 data-plan-title>Dashboard</h1>
      <p>AI 코칭과 함께 오늘의 목표를 확인하세요.</p>
    </div>
    <div class="dashboard-header__actions" style="gap:.5rem; align-items:center;">
      <!-- ✅ C7 훅: 선택 날짜 (없으면 JS에서 오늘로 대체) -->
      <label for="selected-date" class="sr-only">선택 날짜</label>
      <input id="selected-date" type="date" value="{{ today|date:'Y-m-d' }}" />
      <a class="btn btn--ghost" href="{% url 'user_profile' %}">Profile</a>
      <a class="btn btn--primary" href="#insights">AI Insights</a>
    </div>
  </header>

  <div class="dashboard-divider"></div>

  <main class="dashboard-layout">
    <!-- ====== Column A ====== -->
    <section class="dashboard-column">
      <!-- Today Summary (운동/식단/목표 합계) -->
      <article class="dashboard-card dashboard-card--stat">
        <div class="dashboard-card__heading">
          <div>
            <h2>Today Summary</h2>
            <p class="dashboard-card__sub">운동 · 식단 · 목표 한눈에 보기</p>
          </div>
          <span class="badge">Today</span>
        </div>

        <div class="grid grid--3">
          <!-- 운동 합계 (서버 값 유지) -->
          <div class="stat-tile">
            <div class="stat-tile__label">Workout Minutes</div>
            <div class="stat-tile__value">
              {{ today_totals.workout_minutes|default:0 }}<span class="stat-tile__unit"> min</span>
            </div>
          </div>

          <!-- 식단 합계 (서버 값 유지) -->
          <div class="stat-tile">
            <div class="stat-tile__label">Calories / Macros</div>
            <div class="stat-tile__value">
              {{ today_totals.meals.calories|default:0 }}<span class="stat-tile__unit"> kcal</span>
            </div>
            <div class="stat-tile__sub">
              P {{ today_totals.meals.protein|default:0 }}g ·
              C {{ today_totals.meals.carbs|default:0 }}g ·
              F {{ today_totals.meals.fat|default:0 }}g
            </div>
          </div>

          <!-- 목표 합계 (서버 값 유지) -->
          <div class="stat-tile">
            <div class="stat-tile__label">Daily Goals</div>
            <div class="stat-tile__value">
              {{ today_totals.goals.completed|default:0 }}<span class="stat-tile__unit"> / </span>{{ today_totals.goals.total|default:0 }}
            </div>
          </div>
        </div>

        <!-- ✅ C7: Workout Summary (API 라이브) — 기존 값 위에 “추가”만 -->
        <div class="grid grid--4" style="margin-top:12px;">
          <div class="stat-mini">
            <div class="stat-mini__label">총 분</div>
            <div class="stat-mini__value"><strong id="sum-total-min">0</strong></div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini__label">할 일</div>
            <div class="stat-mini__value"><strong id="sum-total-tasks">0</strong></div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini__label">완료</div>
            <div class="stat-mini__value">
              <strong id="sum-completed-tasks">{{ progress_done }}</strong>
            </div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini__label">칼로리</div>
            <div class="stat-mini__value"><strong id="sum-total-kcal">0</strong></div>
          </div>
        </div>
      </article>

      <!-- Progress -->
      <article
        class="dashboard-card dashboard-card--stat"
        id="progress"
        data-progress-total="{{ progress_total }}"
        data-progress-complete="{{ progress_done }}"
      >
        <div class="progress-panel__header">
          <div>
            <h2>Today's Progress</h2>
            <p class="progress-panel__sub">
              {{ summary.total_minutes|default:0 }} min of training · {{ summary.active_plans|default:0 }} active plans
            </p>
          </div>
          <div class="progress-panel__complete">
            <!-- ✅ B3 훅: 진행 퍼센트 텍스트는 JS가 갱신 -->
            <span class="progress-panel__percent" data-progress-text id="progressPercent">{{ progress_complete|default:0 }}%</span>
            <span class="progress-panel__caption">Complete</span>
          </div>
        </div>

        <!-- 기존 progress ring 카드 유지 -->
        <div class="progress-ring-row" id="progressRings">
          {% for item in progress_cards %}
            <div class="progress-ring-wrap progress-ring-wrap--{{ item.color }}">
              {% include "partials/progress_ring.html" with wrapper_class="progress-ring--mini" progress=item.render_percent value=item.render_value label=item.label color=item.color %}
            </div>
          {% endfor %}
        </div>

        <!-- ✅ B3 링 업데이트용 미니 SVG(추가) -->
        <div class="progress-ring-row" aria-hidden="true" style="display:flex;gap:12px;align-items:center;margin-top:8px;">
          <svg class="progress-ring" width="120" height="120">
            <circle class="progress-ring__value-circle" r="54" cx="60" cy="60" stroke-width="12" fill="transparent"></circle>
          </svg>
          <div class="muted">자동 진행률 링(실데이터)</div>
        </div>

        <!-- ✅ B3 훅: 목표 카운트 텍스트도 JS가 실데이터로 덮어씀 -->
        <div class="progress-goal">
          <div class="progress-goal__bar"><span id="progressGoalFill" style="width: 0%"></span></div>
          <p class="progress-goal__text" id="progressGoalLabel">
            <span data-progress-text>0/0</span> daily goals completed
          </p>
        </div>

        <!-- ✅ B3 훅: 상단 상태 배지 -->
        <div style="margin-top:8px;">
          <span class="badge" data-workout-status>Not Started</span>
        </div>
      </article>

      <!-- Daily Tasks (서버 렌더 유지) -->
      <article class="premium-card task-card" id="tasks">
        <div class="task-card__header">
          <div>
            <h3>Daily Tasks</h3>
            <p class="task-card__sub" data-task-count>오늘 목표 {{ daily_tasks|length }}개</p>
          </div>
          <div class="task-card__actions">
            <span class="task-card__calendar" aria-hidden="true">
              <svg viewBox="0 0 24 24" focusable="false">
                <path d="M7 2v3m10-3v3M4.5 8h15m-13 4h4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                <rect x="3" y="5" width="18" height="16" rx="3" ry="3" fill="none" stroke="currentColor" stroke-width="1.6" />
              </svg>
            </span>
            <button type="button" class="task-card__add" data-task-add aria-label="Add daily task">
              <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                <path d="M12 5v14m-7-7h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </button>
          </div>
        </div>

        <ul class="task-card__list" id="dailyTasks">
          {% for task in daily_tasks %}
            <li
              class="task-card__item{% if task.completed %} is-complete{% endif %}"
              data-task-type="{{ task.type }}"
              data-completed="{{ task.completed|yesno:'true,false' }}"
            >
              <label class="task-card__toggle">
                <input type="checkbox" class="task-card__input" data-task-checkbox {% if task.completed %}checked{% endif %}>
                <span
                  class="task-card__checkbox"
                  data-state="{% if task.completed %}checked{% else %}unchecked{% endif %}"
                  aria-hidden="true"
                >
                  <svg viewBox="0 0 24 24" focusable="false">
                    <path d="M20 6 9 17l-5-5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" />
                  </svg>
                </span>
                <span class="task-card__text{% if task.completed %} is-complete{% endif %}">{{ task.text }}</span>
                <span class="task-card__dot task-card__dot--{{ task.type }}" aria-hidden="true"></span>
              </label>
            </li>
          {% endfor %}
        </ul>
      </article>

      <!-- ✅ B3 전용: Workout TaskItem 체크리스트(실데이터 바인딩용, 추가) -->
      <article class="dashboard-card">
        <div class="dashboard-card__heading">
          <div>
            <h2>Workout Tasks</h2>
            <p class="dashboard-card__sub">오늘 플랜의 세부 운동 목록</p>
          </div>
        </div>
        <!-- JS가 채우는 리스트 -->
        <ul class="task-card__list" data-task-list></ul>
        <form data-inline-task-form class="row" style="gap:8px; margin-top:10px;">
          <input type="text"  data-new-name placeholder="Exercise name" required style="min-width:160px;">
          <input type="number" data-new-sets placeholder="sets" min="0" step="1" style="width:80px;">
          <input type="number" data-new-reps placeholder="reps" min="0" step="1" style="width:80px;">
          <input type="number" data-new-min  placeholder="min"  min="0" step="1" style="width:90px;">
          <button type="submit" class="btn">Add</button>
        </form>
      </article>

      <!-- AI Insights (서버 렌더 유지) -->
      <article class="dashboard-card" id="insights">
        <div class="dashboard-card__heading">
          <div>
            <h2>AI Insights</h2>
            <p class="dashboard-card__sub dashboard-card__sub--dark">Updated daily</p>
          </div>
          <span class="badge">Today</span>
        </div>
        <div class="insight-stack">
          {% if ai_loading %}{% include "partials/ai_thinking_dots.html" %}{% endif %}
          {% for insight in ai_insights %}
            <div class="insight insight--{{ insight.type }}">
              <div class="insight__header">
                <h3>{{ insight.title }}</h3>
                <span class="muted">Confidence {{ insight.confidence }}%</span>
              </div>
              <p>{{ insight.message }}</p>
            </div>
          {% endfor %}
        </div>

        <!-- ✅ C8: Live Today Insights (API bullets) 추가 영역 -->
        <div class="insight-stack" style="margin-top:.75rem;">
          <h3 class="muted" style="margin-bottom:.25rem;">Live (API)</h3>
          <div id="insight-bullets"><!-- JS가 bullet 목록 렌더 --></div>
        </div>
      </article>
    </section>

    <!-- ====== Column B ====== -->
    <section class="dashboard-column">
      <!-- Recommendations (서버 렌더 유지) -->
      <article class="dashboard-card" id="recommend">
        <div class="dashboard-card__heading">
          <div>
            <h2>Today's Recommendations</h2>
            <p class="dashboard-card__sub">Tailored picks for you</p>
          </div>
        </div>
        <ul class="recommend-list">
          {% for task in recommendations %}
            <li class="recommend-list__item">
              <div>
                <strong>{{ task.exercise.name }}</strong>
                <span class="muted"> · {{ task.duration_min }} min</span>
              </div>
              <span class="pill">Priority {{ forloop.counter }}</span>
            </li>
          {% empty %}
            <li class="muted">No recommended workouts yet. Update your goals to get suggestions.</li>
          {% endfor %}
        </ul>

        <!-- ✅ C9: Live Recommendations (API) 추가 영역 -->
        <div class="recommend-list" style="margin-top:.75rem;">
          <h3 class="muted" style="margin-bottom:.25rem;">Live (API)</h3>
          <div id="recommendations"><!-- JS가 추천 렌더 --></div>
        </div>
      </article>

      <!-- Quick Actions -->
      <article class="premium-card quick-actions-card">
        <div class="quick-actions__header">
          <h3>Quick Actions</h3>
          <p>Jump right into today's tasks</p>
        </div>
        <div class="quick-actions__grid">
          {% for action in quick_actions %}
            <a href="{{ action.url }}" class="quick-action quick-action--{{ action.variant }}" data-quick-action>
              <span class="quick-action__icon" aria-hidden="true">
                {% if action.icon == 'zap' %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="M13 2 3 14h7l-1 8 10-12h-7Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% elif action.icon == 'camera' %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="M12 10a3 3 0 1 0 0 6 3 3 0 0 0 0-6Zm-9 9V8a3 3 0 0 1 3-3h2.2a1 1 0 0 0 .83-.44l.94-1.41A1.5 1.5 0 0 1 11.18 2h1.64a1.5 1.5 0 0 1 1.21.65l.94 1.41a 1 1 0 0 0 .83.44H18a3 3 0 0 1 3 3v11a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% elif action.icon == 'trend' %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="m3 17 6-6 4 4 7-7" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% else %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="M12 21a9 9 0 1 0-9-9 9 9 0 0 0 9 9Zm0-5a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0-4h.01" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% endif %}
              </span>
              <span class="quick-action__content">
                <span class="quick-action__title">{{ action.title }}</span>
                <span class="quick-action__caption">{{ action.caption }}</span>
              </span>
            </a>
          {% endfor %}
        </div>
      </article>

      <!-- Nutrition Upload -->
      <article class="dashboard-card">
        <div class="dashboard-card__heading">
          <div>
            <h2>Nutrition Upload</h2>
            <p class="dashboard-card__sub">Keep your meals tracked with AI</p>
          </div>
        </div>
        {% include "partials/meal_upload.html" %}
      </article>
    </section>
  </main>

  <a class="floating-button" href="#" aria-label="빠른 추가">＋</a>

  <!-- ✅ C7~C9: 토스트 (옵션) -->
  <div id="toast" class="toast hidden" role="alert" aria-live="polite"></div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'js/dashboard.js' %}"></script>
  <script src="{% static 'js/dashboard.bind.js' %}"></script>
  <script>
  (function () {
    // 1) 소셜 로그인 후 ?access= 쿼리에서 JWT access 토큰 디버깅
    const params = new URLSearchParams(window.location.search);
    const access = params.get("access");
    if (access) {
      const masked = access.length > 20 ? access.slice(0, 10) + "..." + access.slice(-6) : access;
      console.log("✅ 소셜 로그인 완료, JWT access 토큰 발급:", masked);
      if (window.api && typeof window.api.loginSuccess === "function") {
        try {
          window.api.loginSuccess({ access: access, refresh: null });
        } catch (e) {
          console.warn("[DEBUG] api.loginSuccess 호출 중 오류:", e);
        }
      }
      params.delete("access");
      const newQuery = params.toString();
      const newUrl = window.location.pathname + (newQuery ? "?" + newQuery : "") + window.location.hash;
      window.history.replaceState({}, "", newUrl);
    }
    // 2) 로그인 후 탭 재진입/재인증 시 대시보드 재로딩 훅 (기존 로직 유지)
    window.onAuthRehydrate = () => {
      const today = new Date().toISOString().slice(0, 10);
      api.authFetch(`/api/workoutplans/summary/?date=${today}`)
        .then((data) => {
          console.log("[rehydrate] summary", data);
          // 필요하면 여기서 progress, summary 등 화면 갱신 로직 추가
        })
        .catch(console.error);
    };
  })();
  </script>
{% endblock %}
