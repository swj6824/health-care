{% extends "base.html" %}
{% load static %}
{% block title %}로그인{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}
<div class="auth-shell">
  <div class="auth-grid">
    <section class="auth-panel">
      <div class="auth-form">
        <div class="auth-logo">H</div>
        <header class="auth-header">
          <h1>Welcome back</h1>
          <p>Sign in to your account</p>
        </header>

        <!-- 소셜 로그인 -->
        <div class="auth-oauth" style="margin-bottom: .75rem;">
          <a
            class="oauth-button oauth-button--kakao"
            href="{% url 'users:kakao_login' %}"
            aria-label="카카오 로그인"
            data-oauth="kakao"
          >
            <span class="oauth-button__icon oauth-button__icon--kakao" aria-hidden="true">K</span>
            <span>Continue with Kakao</span>
          </a>
          <a
            class="oauth-button oauth-button--naver"
            href="{% url 'users:naver_login' %}"
            aria-label="네이버 로그인"
            data-oauth="naver"
          >
            <span class="oauth-button__icon" aria-hidden="true">
              <img src="{% static 'img/naver.svg' %}" alt="Naver" />
            </span>
            <span>Continue with Naver</span>
          </a>
        </div>

        <div class="auth-divider" style="margin-top:0"><span>Sign in</span></div>

        <!-- 세션 로그인 폼 (제출 직전 JWT 선발급) -->
        <form method="post" action="{% url 'login' %}" class="auth-fields" novalidate id="loginForm">
          {% csrf_token %}

          {% if next %}
            <input type="hidden" name="next" value="{{ next }}">
          {% else %}
            <input type="hidden" name="next" value="{% url 'tasks:dashboard' %}">
          {% endif %}

          {% if form.non_field_errors %}
            <div class="auth-error" aria-live="polite">
              {% for error in form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <label class="auth-field" for="id_username">
            <span>Email</span>
            <input
              type="email"
              name="username"
              id="id_username"
              value="{{ form.username.value|default_if_none:'' }}"
              class="auth-input"
              placeholder="Enter your email"
              required
              autocomplete="username"
              inputmode="email"
            />
            {% if form.username.errors %}
              <small class="auth-error-text">{{ form.username.errors.0 }}</small>
            {% endif %}
          </label>

          <label class="auth-field" for="id_password">
            <span>Password</span>
            <input
              type="password"
              name="password"
              id="id_password"
              class="auth-input auth-input--password"
              placeholder="Enter your password"
              required
              autocomplete="current-password"
            />
            {% if form.password.errors %}
              <small class="auth-error-text">{{ form.password.errors.0 }}</small>
            {% endif %}
          </label>

          <div class="auth-meta">
            <label class="auth-remember">
              <input type="checkbox" name="remember" />
              <span>Remember me</span>
            </label>
            <a href="{% url 'password_reset' %}" class="auth-link">Forgot password?</a>
          </div>

          <button type="submit" class="auth-submit" id="loginSubmitBtn">Sign in</button>
          <p class="auth-error" id="jwtInlineErr" style="display:none;margin-top:.75rem;" aria-live="polite"></p>
        </form>

        <p class="auth-footer" style="margin-top:1rem;">
          계정이 없으신가요?
          <a href="{% url 'user_signup' %}{% if next %}?next={{ next|urlencode }}{% endif %}" class="auth-link">Create an account</a>
        </p>
      </div>
    </section>

    <aside class="auth-side">
      <div class="auth-side__quote">
        <blockquote>
          <p>“Secure session + JWT, best of both.”</p>
        </blockquote>
      </div>
    </aside>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
  // ==============================
  // 0) 회원가입 -> 로그인 자동진입
  //    signup 페이지가 sessionStorage.autoLogin 에 {u,p,next} 저장 후
  //    여기로 돌아오면 자동으로 JWT + 세션로그인 진행
  // ==============================
  (function () {
    const payload = sessionStorage.getItem('autoLogin');
    if (!payload) return;

    try {
      const { u, p, next } = JSON.parse(payload);
      sessionStorage.removeItem('autoLogin');

      const form = document.getElementById('loginForm');
      if (form) {
        const uEl = form.querySelector('#id_username');
        const pEl = form.querySelector('#id_password');
        if (uEl && pEl) {
          uEl.value = u || '';
          pEl.value = p || '';
        }
        if (next) {
          const nextEl = form.querySelector('input[name="next"]');
          if (nextEl) nextEl.value = next;
        }
        // 즉시 제출 → 아래 1) 로직으로 JWT + 세션 로그인
        setTimeout(() => form.requestSubmit(), 0);
      }
    } catch (_) {
      sessionStorage.removeItem('autoLogin');
    }
  })();

  // ==============================
  // 1) 일반 로그인: JWT 선발급 후 세션 로그인
  // ==============================
  (function () {
    const form =
      document.querySelector('form[action*="login"]') ||
      document.querySelector('form.auth-fields');
    if (!form) return;

    const submitBtn = document.getElementById('loginSubmitBtn');
    const jwtErr = document.getElementById('jwtInlineErr');
    let submitting = false;

    function setLoading(flag) {
      submitting = !!flag;
      if (!submitBtn) return;
      submitBtn.disabled = submitting;
      submitBtn.classList.toggle('is-loading', submitting);
    }
    function showJwtError(msg) {
      if (!jwtErr) return;
      jwtErr.textContent = msg || 'Token fetch failed. Continuing with session login.';
      jwtErr.style.display = 'block';
    }

    form.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && submitting) e.preventDefault();
    });

    form.addEventListener('submit', async (e) => {
      if (submitting) { e.preventDefault(); return; }
      e.preventDefault();

      const uEl = form.querySelector('input[name="username"], #id_username');
      const pEl = form.querySelector('input[name="password"], #id_password');
      const username = (uEl && uEl.value || '').trim();
      const password = (pEl && pEl.value) || '';

      if (!username || !password) { form.submit(); return; }

      setLoading(true);
      if (jwtErr) jwtErr.style.display = 'none';

      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), 2000); // 2초 타임아웃

      try {
        const res = await fetch('/auth/token/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ username, password }),
          signal: ctrl.signal
        });

        if (res.ok) {
          const t = await res.json();
          if (window.api && typeof api.loginSuccess === 'function') {
            api.loginSuccess(t); // access/refresh 저장 + 만료 자동 갱신
          } else {
            if (t?.access) localStorage.setItem('access', t.access);
            if (t?.refresh) localStorage.setItem('refresh', t.refresh);
          }
        } else {
          try {
            const text = await res.text();
            const j = text ? JSON.parse(text) : null;
            const msg = (j && (j.detail || j.message)) || text || ('HTTP ' + res.status);
            showJwtError(msg);
          } catch {
            showJwtError('Cannot get JWT token.');
          }
        }
      } catch (_) {
        showJwtError('Network issue while fetching token.');
      } finally {
        clearTimeout(timer);
        setLoading(false);
        form.submit(); // 세션 로그인 진행
      }
    }, { capture: true });
  })();
  </script>
{% endblock %}
